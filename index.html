<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AiLov Nebula Console</title>
<style>
:root {
  --bg0: #04070b;
  --bg1: #0b1628;
  --fg: #e9eefb;
}

html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  background: radial-gradient(1200px 900px at 20% 10%, var(--bg1), var(--bg0));
  color: var(--fg);
  font-family: Inter, system-ui, sans-serif;
}

/* Titolo poetico */
.hero {
  text-align: center;
  padding: 20px;
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  z-index: 10;
  background: rgba(5, 10, 20, 0.4);
  backdrop-filter: blur(6px);
}
.hero .name {
  color: #8cb8ff;
  font-weight: 700;
}

/* Nebula canvas */
canvas#nebula {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100%; height: 100%;
  display: block;
}

/* Finestra modulare AiLov */
.ailov-window {
  position: absolute;
  left: 50%;
  bottom: 20px;
  transform: translateX(-50%);
  width: min(520px, 92vw);
  background: rgba(10, 14, 22, 0.55);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 20;
}
/* Barra strumenti */
.toolbar {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
.toolbar button {
  background: rgba(255,255,255,0.08);
  border: none;
  color: white;
  font-size: 18px;
  border-radius: 8px;
  width: 36px;
  height: 36px;
  cursor: pointer;
  transition: background 0.2s;
}
.toolbar button:hover {
  background: rgba(255,255,255,0.2);
}

/* Contenuti interni */
.content {
  padding: 12px;
}
.panel { display: none; }
.panel.active { display: block; }

.log {
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 8px;
}
.msg { margin: 6px 0; }
.prompt {
  display: flex;
  gap: 8px;
}
.prompt input {
  flex: 1;
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.1);
  background: rgba(0,0,0,0.4);
  color: var(--fg);
}
.prompt button {
  background: #1f6fff;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
}
  :root{ --bg0:#05070b; --bg1:#071020; --fg:#e9eefb; }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 900px at 20% 10%, var(--bg1) 0%, var(--bg0) 55%, #00050a 100%);
    color:var(--fg); font:500 16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  /* evitiamo aspect-ratio: altezza esplicita ‚Üí funziona anche su preview iPad */
  .wrap{
    width:min(1100px, 94vw);
    height:min(720px, 72vh);
    margin:4vh auto; position:relative; border-radius:18px; overflow:hidden;
    box-shadow:0 10px 40px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.04);
    background: radial-gradient(900px 700px at 50% 50%, #0a1324 0%, #060a12 65%, #04070c 100%);
  }
  header{position:absolute; inset:14px auto auto 16px; z-index:2; font-weight:700; letter-spacing:.2px}
  .hint{position:absolute; left:50%; bottom:18px; transform:translateX(-50%); z-index:2;
        background:rgba(10,14,22,.55); border:1px solid rgba(255,255,255,.06);
        padding:10px 14px; border-radius:14px; backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
        font-weight:600}
  canvas{position:absolute; inset:0; width:100%; height:100%; display:block}
/* === AiLov Console (unica finestra) === */
.console {
  position:absolute; right:18px; bottom:18px; z-index:5;
  width:min(520px, 92vw);
  background:rgba(10,14,22,.55);
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px; padding:12px;
  backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
  box-shadow:0 10px 30px rgba(0,0,0,.45);
}
.console .log {
  max-height:min(40vh, 360px); overflow:auto; padding:4px 2px 8px 2px;
}
.msg { margin:6px 0; display:flex; gap:8px; }
.msg .you, .msg .ai {
  padding:10px 12px; border-radius:12px; line-height:1.35;
  border:1px solid rgba(255,255,255,.06);
}
.msg .you { background:rgba(255,255,255,.06); }
.msg .ai  { background:rgba(20,28,44,.55); }
.msg .tag { opacity:.7; font-size:.85rem; min-width:3.6rem }
.prompt {
  display:flex; gap:8px; margin-top:8px;
}
.prompt input {
  flex:1; height:40px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.35); color:#e9eefb; padding:0 12px;
}
.prompt button {
  padding:0 14px; border-radius:10px; border:1px solid rgba(255,255,255,.1);
  background:#1f6fff; color:white; height:40px;
}
.prompt .ghost {
  background:transparent; color:#e9eefb; border-color:rgba(255,255,255,.18);
}
</style>
</head>
<body>
  <header class="hero">
    <h1>Ciao, sono <span class="name">AiLov</span>. Parliamo? ‚ú®</h1>
  </header>

  <canvas id="nebula"></canvas>
<!-- FINESTRA UNICA AiLov (centrata sotto la Nebula) -->
<div id="ailov-window" class="ailov-window" role="dialog" aria-label="Console AiLov">
  <div class="toolbar">
    <button id="btnVoice" title="Parla">üéôÔ∏è</button>
    <button id="btnChat"  title="Chat">üí¨</button>
    <button id="btnNode"  title="Nodo">üîç</button>
    <button id="btnClose" title="Chiudi">√ó</button>
  </div>

  <div class="content">
    <!-- pannello chat -->
    <div id="chatPanel" class="panel active">
      <div id="log" class="log" aria-live="polite"></div>
      <form id="promptBar" class="prompt">
        <input id="prompt" autocomplete="off" placeholder="Scrivi o parla con AiLov‚Ä¶" />
        <button id="sendBtn" type="submit">Invia</button>
      </form>
    </div>

    <!-- pannello nodo -->
    <div id="nodePanel" class="panel">
      <p id="nodeInfo">Tocca un nodo nella Nebula‚Ä¶</p>
    </div>
  </div>
</div>
  <!-- NEBULA ENGINE -->
<script>
/* === NEBULA ENGINE (animazione + click) ================= */

//// Parametri
const PARTICLES=420, MAX_LINKS_NODE=3, LINK_RADIUS_FR=0.20, NODE_SIZE=1.2;
const LINE_ALPHA_BASE=0.12, LINE_ALPHA_PULSE=0.08, SAT=92, LUM=66, CORE_STRENGTH=1.05;
const PULSE_HZ=0.85, PULSE_AMPL=0.055, JITTER_FR=0.012, RADIUS_FR=0.38, DPR_CAP=2;
const ROTATE_HZ = 0.010;   // giri al secondo (0.010 ‚âà 1 giro ogni ~100s)

//// Canvas
const cvs = document.getElementById('nebula');
const ctx = cvs.getContext('2d', { alpha:true });

let w=0,h=0,cx=0,cy=0, baseR=0, dpr=1;
const TAU = Math.PI*2;

//// Dimensionamento (tenendo conto del titolo .hero)
const hero = document.querySelector('.hero');
function resize(){
  const safeTop = hero ? hero.offsetHeight : 0;
  const wpx = window.innerWidth;
  const hpx = Math.max(200, window.innerHeight - safeTop);

  cvs.style.top    = safeTop + 'px';
  cvs.style.width  = wpx + 'px';
  cvs.style.height = hpx + 'px';

  dpr = Math.min(window.devicePixelRatio || 1, DPR_CAP);
  cvs.width  = Math.floor(wpx * dpr);
  cvs.height = Math.floor(hpx * dpr);

  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  w = wpx; h = hpx; cx = w/2; cy = h/2;
  baseR = Math.min(w,h) * RADIUS_FR;
}
window.addEventListener('resize', ()=>{ resize(); spawn(); }, {passive:true});

//// Nodi stabili
const nodes=[];
function spawn(){
  nodes.length=0;
  for(let i=0;i<PARTICLES;i++){
    const u=Math.random(), v=Math.random();
    const r0=Math.sqrt(u)*(baseR*0.98), th=TAU*v, hue=(th*180/Math.PI+360)%360;
    nodes.push({r0, th, hue, seed:Math.random()*1000});
  }
}

function pulseAt(t){ return 1 + PULSE_AMPL * Math.sin(TAU*PULSE_HZ*t); }

/* --- Rotazione automatica + manuale (drag) --- */
let rotOffset = 0;
let drag = false, lastX = 0;

function framePositions(t, p){
  const jitter = baseR * JITTER_FR;
  const rot    = t * TAU * ROTATE_HZ;
  const out    = new Array(nodes.length);
  for (let i = 0; i < nodes.length; i++){
    const n  = nodes[i];
    const r  = n.r0 * p;
    const a  = n.th + rot + rotOffset; // auto + manuale
    const jx = Math.sin(t*1.25 + n.seed) * jitter;
    const jy = Math.cos(t*1.55 + n.seed) * jitter;
    out[i] = { x: cx + Math.cos(a)*r + jx, y: cy + Math.sin(a)*r + jy, hue: n.hue };
  }
  return out;
}

cvs.addEventListener('mousedown', e => { drag = true;  lastX = e.clientX; });
cvs.addEventListener('mouseup',   () => { drag = false; });
cvs.addEventListener('mouseleave',() => { drag = false; });
cvs.addEventListener('mousemove', e => {
  if (!drag) return;
  const dx = e.clientX - lastX; lastX = e.clientX;
  rotOffset += dx * 0.002;
});
cvs.addEventListener('touchstart', e => { drag = true;  lastX = e.touches[0].clientX; }, {passive:true});
cvs.addEventListener('touchend',   () => { drag = false; }, {passive:true});
cvs.addEventListener('touchmove',  e => {
  if (!drag) return;
  const dx = e.touches[0].clientX - lastX; lastX = e.touches[0].clientX;
  rotOffset += dx * 0.002;
}, {passive:true});

/* --- Rendering --- */
function drawCoreGlow(p){
  const r=baseR*1.18*p;
  const g=ctx.createRadialGradient(cx,cy,r*0.06,cx,cy,r);
  const F=CORE_STRENGTH;
  g.addColorStop(0.00,`rgba(255,220,140,${0.30*F})`);
  g.addColorStop(0.30,`rgba(240,110,200,${0.22*F})`);
  g.addColorStop(0.65,`rgba(110,160,255,${0.16*F})`);
  g.addColorStop(1.00,`rgba(10,18,36,0.00)`);
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx,cy,r,0,TAU); ctx.fill();
}

function drawLinks(pts,p){
  const linkR=baseR*LINK_RADIUS_FR;
  const aBase=LINE_ALPHA_BASE + LINE_ALPHA_PULSE * (p-1)/PULSE_AMPL * 0.5;
  ctx.lineWidth=Math.max(1,0.9*dpr);
  for(let i=0;i<pts.length;i++){
    let links=0; const a=pts[i];
    for(let j=i+1;j<pts.length && links<MAX_LINKS_NODE;j++){
      const b=pts[j], d=Math.hypot(a.x-b.x,a.y-b.y);
      if(d<linkR){
        const t=1-d/linkR;
        ctx.strokeStyle=`hsla(${((a.hue+b.hue)/2).toFixed(1)},85%,75%,${(aBase*(0.25+t*0.75)).toFixed(3)})`;
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        links++;
      }
    }
  }
}

function drawNodes(pts,p){
  const r=NODE_SIZE*dpr;
  ctx.shadowColor='rgba(255,255,255,0.28)';
  ctx.shadowBlur=7*dpr*(0.9+0.2*(p-1)/PULSE_AMPL);
  for(const q of pts){
    ctx.fillStyle=`hsl(${q.hue.toFixed(1)} ${SAT}% ${LUM+10*(p-1)/PULSE_AMPL}%)`;
    ctx.beginPath(); ctx.arc(q.x,q.y,r,0,TAU); ctx.fill();
  }
  ctx.shadowBlur=0;
}

function clipCircle(radius){ ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,radius,0,TAU); ctx.clip(); }

function step(tms){
  const now=tms/1000, p=pulseAt(now);
  ctx.clearRect(0,0,cvs.width,cvs.height);
  clipCircle(baseR*1.06*p);
  drawCoreGlow(p);
  const pts=framePositions(now,p);
  drawLinks(pts,p);
  drawNodes(pts,p);
  ctx.restore();
  requestAnimationFrame(step);
}

function start(){ resize(); spawn(); requestAnimationFrame(step); }
start();

/* --- UI finestra: chat + voce + pannelli --- */
const winEl     = document.getElementById('ailov-window');
const btnVoice  = document.getElementById('btnVoice');
const btnChat   = document.getElementById('btnChat');
const btnNode   = document.getElementById('btnNode');
const btnClose  = document.getElementById('btnClose');
const chatPanel = document.getElementById('chatPanel');
const nodePanel = document.getElementById('nodePanel');
const nodeInfoEl= document.getElementById('nodeInfo');
const logEl     = document.getElementById('log');
const formEl    = document.getElementById('promptBar');
const inputEl   = document.getElementById('prompt');

btnChat.onclick = () => { chatPanel.classList.add('active'); nodePanel.classList.remove('active'); };
btnNode.onclick = () => { nodePanel.classList.add('active'); chatPanel.classList.remove('active'); };
btnClose.onclick= () => { winEl.style.display = 'none'; };

function appendMsg(role, text){
  const row = document.createElement('div');
  row.className = 'msg';
  row.textContent = (role === 'you' ? 'Tu: ' : 'AiLov: ') + text;
  logEl.append(row);
  logEl.scrollTop = logEl.scrollHeight;
}
function brain(msg){
  msg = msg.trim();
  if(!msg) return null;
  if(/^ciao|hey|salve/i.test(msg)) return 'Ciao! üåø';
  if(/come stai/i.test(msg))       return 'Bene! La Nebula √® viva stasera.';
  return 'Ricevuto. Tocca un nodo o fammi una domanda.';
}
formEl.addEventListener('submit', (e)=>{
  e.preventDefault();
  const q = inputEl.value; inputEl.value = '';
  appendMsg('you', q);
  const a = brain(q); if(a) appendMsg('ai', a);
});

// voce
let rec = null, recognizing = false;
if('webkitSpeechRecognition' in window){
  rec = new webkitSpeechRecognition();
  rec.lang = 'it-IT'; rec.continuous = false; rec.interimResults = false;
  rec.onresult = (ev)=>{
    const txt = ev.results[0][0].transcript;
    appendMsg('you', txt);
    const a = brain(txt); if(a) appendMsg('ai', a);
  };
  rec.onend = ()=>{ recognizing = false; };
}
btnVoice.onclick = ()=>{
  if(!rec){ appendMsg('ai','Microfono non disponibile su questo dispositivo.'); return; }
  if(!recognizing){ recognizing = true; rec.start(); } else { recognizing = false; rec.stop(); }
};

// click sulla Nebula ‚Üí info nodo
cvs.addEventListener('click', (ev) => {
  const rect = cvs.getBoundingClientRect();
  const x = ev.clientX - rect.left;
  const y = ev.clientY - rect.top;
  const t = performance.now()/1000, p = pulseAt(t), pts = framePositions(t,p);
  let best=null, bestD=1e9;
  for(const q of pts){ const d=Math.hypot(q.x-x,q.y-y); if(d<bestD){bestD=d; best=q;} }
  if(best && bestD<baseR*0.12){
    nodeInfoEl.textContent = `Nodo vicino: tonalit√† ${Math.round(best.hue)}¬∞, legami locali visibili.`;
    btnNode.click();
  }
});

/* --- Trascinamento finestra AiLov --- */
(function makeDraggable(win) {
  let isDown=false, startX=0, startY=0, startLeft=0, startTop=0;
  const toolbar = win.querySelector('.toolbar');
  toolbar.style.cursor = 'move';
  toolbar.addEventListener('mousedown', e=>{
    isDown=true; startX=e.clientX; startY=e.clientY;
    const r=win.getBoundingClientRect(); startLeft=r.left; startTop=r.top;
    win.style.transition='none';
  });
  document.addEventListener('mouseup', ()=> isDown=false);
  document.addEventListener('mousemove', e=>{
    if(!isDown) return;
    const dx=e.clientX-startX, dy=e.clientY-startY;
    win.style.left = startLeft + dx + 'px';
    win.style.top  = startTop + dy + 'px';
    win.style.transform='none';
  });
})(winEl);

</script>
</body>
</html>
